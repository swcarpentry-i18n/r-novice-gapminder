---
title: データの出力
teaching: 10
exercises: 10
source: Rmd
---

::::::::::::::::::::::::::::::::::::::: objectives

- To be able to write out plots and data from R.

::::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::: questions

- How can I save plots and data created in R?

::::::::::::::::::::::::::::::::::::::::::::::::::

```{r, include=FALSE}
library("ggplot2")
gapminder <- read.csv("data/gapminder_data.csv", header = TRUE)
dir.create("cleaned-data")
```

## Saving plots

`ggsave` 関数を使って、`ggplot2` を用いて作った直近の図を保存する方法は既に学んだ通りです。 おさらいしておきましょう。

```{r, eval=FALSE}
ggsave("My_most_recent_plot.pdf")
```

RStudio から図を保存するには "Plot" ウィンドウにある "Export" ボタンを使います。 この機能を使うと、図を .pdf や .png、.jpg など様々な画像形式で保存することができます。

図を "Plot" ウィンドウに表示することなく保存したいこともあるでしょう。 ページごとに一つの図を含むような複数のページから成る PDF を出力したいこともあるでしょう。 あるいはループを使ってファイル中のデータの絞り込み条件を変えながら複数の図を作成していて、 一つずつ保存するためにいちいちループを止めて "Export" ボタンを押すことが不可能な場合もあるでしょう。

このような場合、より柔軟な方法を使います。 `pdf` 関数は新たに PDF デバイスを作ります。 この関数に引数を指定することで、サイズや解像度を調整できます。

```{r, eval=FALSE}
~~~ pdf("Life_Exp_vs_time.pdf", width=12, height=4) ggplot(data=gapminder, aes(x=year, y=lifeExp, colour=country)) + geom_line() + theme(legend.position = "none") # PDF デバイスを確実に終了しておく必要があります！
```

このドキュメントを開いて内容を確認してみましょう。

:::::::::::::::::::::::::::::::::::::::  challenge

## チャレンジ１

Rewrite your 'pdf' command to print a second
page in the pdf, showing a facet plot (hint: use `facet_grid`)
of the same data with one panel per continent.

:::::::::::::::  solution

## チャレンジ８の解答 1

```{r, eval=FALSE}
pdf("Life_Exp_vs_time.pdf", width = 12, height = 4)
p <- ggplot(data = gapminder, aes(x = year, y = lifeExp, colour = country)) +
  geom_line() +
  theme(legend.position = "none")
p
p + facet_grid(~continent)
dev.off()
```

:::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::::::::::::::::

同様にして `jepg` や `png` などのコマンドを使うことで、他の形式のドキュメントを作成できます。

## データの出力

R からデータを出力したいこともあります。

これには、既に使った `read.table` 関数とよく似た `write.table` 関数を使います。

データを綺麗にするスクリプトを書きましょう。 今回の分析では、gapminder データの中のオーストラリアに該当する部分だけを使います。

```{r}
aust_subset <- gapminder[gapminder$country == "Australia",]

write.table(aust_subset,
  file="cleaned-data/gapminder-aus.csv",
  sep=","
)
```

シェルに戻ってデータが正しく出力されているか確認しましょうOK:

```{r, engine="bash"}
head cleaned-data/gapminder-aus.csv
```

Hmm, that's not quite what we wanted. Where did all these
quotation marks come from? Also the row numbers are
meaningless.

ヘルプファイルを見てこの動作を変更しましょう。

```{r, eval=FALSE}
?write.table
```

既定では、R は文字列をファイルに出力する時に引用符で囲みます。 また、行と列の名前も出力します。

以下のように修正しましょう。

```{r}
write.table(
  gapminder[gapminder$country == "Australia",],
  file="cleaned-data/gapminder-aus.csv",
  sep=",", quote=FALSE, row.names=FALSE
)
```

もう一度シェルを使ってデータを確認してみましょう。

```{r, engine="bash"}
head cleaned-data/gapminder-aus.csv
```

よくなりました！

:::::::::::::::::::::::::::::::::::::::  challenge

## チャレンジ２

gapminder データを1990年以降のデータのみに絞り込むスクリプトを書いて下さい。

このスクリプトを使って絞り込んだ結果を `cleaned-data/` ディレクトリ中のファイルに出力しましょう。

:::::::::::::::  solution

## チャレンジ８の解答

```{r, eval=FALSE}
チャレンジ1990の解答 ~~~ write.table( gapminder[gapminder$year , ], file = "cleaned-data/gapminder-after1990.csv", sep = ",", quote = FALSE, row.names = FALSE)
```

:::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::::::::::::::::

```{r, echo=FALSE}
# We remove after rendering the lesson, because we don't want this in the lesson
# repository
unlink("cleaned-data", recursive=TRUE)
```

:::::::::::::::::::::::::::::::::::::::: keypoints

- Save plots from RStudio using the 'Export' button.
- Use `write.table` to save tabular data.

::::::::::::::::::::::::::::::::::::::::::::::::::
